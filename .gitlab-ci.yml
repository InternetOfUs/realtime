  stages:
    - check_docker_exist
    - build_image
    - coverage
    - push
    - push_version
 
  check_docker_exist:
    stage: check_docker_exist
    script:
      - docker info
 
  build_image:
    stage: build_image
    script:
      - docker build . -t docker.idiap.ch/wenet/wenet-realtime
  coverage:
    stage: coverage
    script:
      - ./docker_run_tests.sh

  push:
   stage: push
   only:
      - master
   script:
      - echo $CI_JOB_TOKEN | docker login docker.idiap.ch -u gitlab-ci-token --password-stdin
      - docker push docker.idiap.ch/wenet/wenet-realtime:latest
      - echo $DOCKERHUB_PASS | docker login -u $DOCKERHUB_USER --password-stdin
      - docker tag docker.idiap.ch/wenet/wenet-realtime:latest internetofus/wenet-realtime:latest
      - docker push internetofus/wenet-realtime:latest

  push_version:
   stage: push_version
   only:
      - tags
   script:
      - echo $CI_JOB_TOKEN | docker login docker.idiap.ch -u gitlab-ci-token --password-stdin
      - docker tag  docker.idiap.ch/wenet/wenet-realtime:latest docker.idiap.ch/wenet/wenet-realtime:$CI_COMMIT_TAG
      - docker push docker.idiap.ch/wenet/wenet-realtime:$CI_COMMIT_TAG
      - echo $DOCKERHUB_PASS | docker login -u $DOCKERHUB_USER --password-stdin
      - docker tag docker.idiap.ch/wenet/wenet-realtime:$CI_COMMIT_TAG internetofus/wenet-realtime:$CI_COMMIT_TAG
      - docker push internetofus/wenet-realtime:$CI_COMMIT_TAG

 